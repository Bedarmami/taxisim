const sqlite3 = require('sqlite3').verbose();
const path = require('path');

// Change this to 'taxi.db' if running on a live server file
const dbPath = path.join(__dirname, 'data', 'railway_dump.db');
const db = new sqlite3.Database(dbPath);

const suspectId = '1288177696';

const run = (sql, params = []) => new Promise((resolve, reject) => {
    db.run(sql, params, (err) => {
        if (err) reject(err);
        else resolve();
    });
});

const query = (sql, params = []) => new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
        if (err) reject(err);
        else resolve(rows);
    });
});

async function remediate() {
    try {
        console.log(`--- REMEDIATION START for suspect ${suspectId} ---`);

        // 1. Get stations owned by exploiter
        const stations = await query('SELECT id, name FROM gas_stations WHERE owner_id = ?', [suspectId]);
        console.log(`Exploiter owns ${stations.length} stations:`, stations.map(s => s.name).join(', '));

        // 2. Reclaim stations (Reset owner to NULL, stock to basic)
        if (stations.length > 0) {
            await run('UPDATE gas_stations SET owner_id = NULL, fuel_stock = 100 WHERE owner_id = ?', [suspectId]);
            console.log('✅ All stations reclaimed by SYSTEM.');
        }

        // 3. Reset user balance and ban
        await run('UPDATE users SET balance = 250, total_earned = 0, is_banned = 1 WHERE telegram_id = ?', [suspectId]);
        console.log('✅ User balance reset to 250 and user is BANNED.');

        console.log('\n--- VERIFICATION ---');
        const user = await query('SELECT telegram_id, balance, is_banned FROM users WHERE telegram_id = ?', [suspectId]);
        console.table(user);

        const checkStations = await query('SELECT id, name, owner_id FROM gas_stations WHERE owner_id = ?', [suspectId]);
        console.log(`Owned stations after fix: ${checkStations.length}`);

    } catch (e) {
        console.error('ERROR during remediation:', e);
    } finally {
        db.close();
    }
}

remediate();
