const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.join(__dirname, 'data', 'railway_dump.db');
const db = new sqlite3.Database(dbPath);

const query = (sql, params = []) => new Promise((resolve, reject) => {
    db.all(sql, params, (err, rows) => {
        if (err) reject(err);
        else resolve(rows);
    });
});

async function analyze() {
    try {
        console.log('--- Top 20 Richest Users ---');
        const topUsers = await query('SELECT telegram_id, balance, total_earned, rides_total FROM users ORDER BY balance DESC LIMIT 20');
        console.table(topUsers);

        console.log('\n--- ALL Owned Gas Stations ---');
        const stations = await query(`
            SELECT gs.id, gs.name, gs.owner_id, u.balance as owner_balance
            FROM gas_stations gs
            INNER JOIN users u ON gs.owner_id = u.telegram_id
        `);
        console.table(stations);

        console.log('\n--- Identifying Potential Exploiter ---');
        // A potential exploiter has high balance but low rides_total
        const suspects = await query('SELECT telegram_id, balance, total_earned, rides_total FROM users WHERE balance > 1000000 OR (balance > 100000 AND rides_total < 50)');
        if (suspects.length > 0) {
            console.log('SUSPECTED EXPLOITERS:');
            console.table(suspects);
        } else {
            console.log('No obvious suspects found in top list.');
        }

    } catch (e) {
        console.error(e);
    } finally {
        db.close();
    }
}

analyze();
