const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.resolve(__dirname, 'data', 'taxi.db');
const db = new sqlite3.Database(dbPath);

console.log('Searching for users with multiple cars or suspicious purchases...');

db.serialize(() => {
    // Find users with multiple rows in car_inventory
    db.all(`
        SELECT u.id, u.username, u.balance, COUNT(ci.id) as car_count 
        FROM users u 
        JOIN car_inventory ci ON u.id = ci.user_id 
        GROUP BY u.id 
        HAVING car_count >= 3
        ORDER BY car_count DESC
    `, [], (err, rows) => {
        if (err) {
            console.error(err.message);
            return;
        }
        console.log('Users with 3+ cars:');
        console.table(rows);
    });

    // Find users who had massive activity in user_activity recently
    db.all(`
        SELECT user_id, action, COUNT(*) as count 
        FROM user_activity 
        WHERE action LIKE '%CRASH%' OR action LIKE '%WIN%'
        GROUP BY user_id, action 
        HAVING count > 10
        ORDER BY count DESC
        LIMIT 10
    `, [], (err, rows) => {
        if (err) {
            console.error(err.message);
            return;
        }
        console.log('\nUsers with high Crash activity:');
        console.table(rows);
    });
});

db.close();
