const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.resolve(__dirname, 'data', 'taxi.db');
const db = new sqlite3.Database(dbPath);

console.log('Searching for users with 3+ cars or suspicious balances...');

db.serialize(() => {
    db.all("SELECT id, telegram_id, username, balance, owned_cars_data FROM users", [], (err, rows) => {
        if (err) {
            console.error(err.message);
            return;
        }

        const suspicious = rows.filter(row => {
            try {
                const cars = JSON.parse(row.owned_cars_data || '[]');
                return cars.length >= 3 || row.balance > 50000;
            } catch (e) {
                return false;
            }
        });

        console.log('Found', suspicious.length, 'suspicious users:');
        suspicious.forEach(user => {
            const cars = JSON.parse(user.owned_cars_data || '[]');
            console.log(`- ${user.username} (ID: ${user.telegram_id || user.id}) - Balance: ${user.balance} - Cars: ${cars.length}`);
            if (cars.length > 0) {
                console.log(`  Cars: ${cars.map(c => c.name || c.id).join(', ')}`);
            }
        });
    });
});

db.close();
